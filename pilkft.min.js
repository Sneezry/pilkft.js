/**
*  
*  Pyramidal Implementation of the Lucas Kanade Feature Tracker
*                                by Sneezry, 2014-11-12
*                                lizhe@lizhe.org
*                                MIT License
* 
**/
function pilkft(z,a,r){var m=a.length,n=a[0].length,t=[];t.push(a);var h=[];h.push(r);for(var e=[],d=[],b=0;b<m;b++){e[b]=[];d[b]=[];for(var c=0;c<n;c++)e[b][c]=a[b][c],d[b][c]=r[b][c]}for(a=1;4>a;a++){m=Math.floor(e.length/2);n=Math.floor(e[0].length/2);r=[];for(var v=[],b=0;b<m;b++)for(r[b]=[],v[b]=[],c=0;c<n;c++)r[b][c]=e[2*b][2*c]/4+e[2*b][Math.max(0,2*c-1)]/8+e[2*b][Math.min(n-1,2*c+1)]/8+e[Math.max(0,2*b-1)][2*c]/8+e[Math.min(m-1,2*b+1)][2*c]/8+e[Math.max(0,2*b-1)][Math.max(0,2*c-1)]/16+e[Math.max(0,2*b-1)][Math.min(n-1,2*c+1)]/16+e[Math.min(m-1,2*b+1)][Math.max(0,2*c-1)]/16+e[Math.min(m-1,2*b+1)][Math.min(n-1,2*c+1)]/16,v[b][c]=d[2*b][2*c]/4+d[2*b][Math.max(0,2*c-1)]/8+d[2*b][Math.min(n-1,2*c+1)]/8+d[Math.max(0,2*b-1)][2*c]/8+d[Math.min(m-1,2*b+1)][2*c]/8+d[Math.max(0,2*b-1)][Math.max(0,2*c-1)]/16+d[Math.max(0,2*b-1)][Math.min(n-1,2*c+1)]/16+d[Math.min(m-1,2*b+1)][Math.max(0,2*c-1)]/16+d[Math.min(m-1,2*b+1)][Math.min(n-1,2*c+1)]/16;t.push(r);e=r;h.push(v);d=v}e=[];for(a=0;4>a;a++)for(e[a]=[],d=0;d<z.length;d++)e[a][d]={x:z[d].x/(1<<a),y:z[d].y/(1<<a),v:{x:0,y:0}};for(d=0;d<z.length;d++)for(a=3;0<=a;a--)for(m=t[a].length,n=t[a][0].length,4!=a+1&&(e[a][d].v.x=2*e[a+1][d].v.x,e[a][d].v.y=2*e[a+1][d].v.y),r=0;5>r;r++){for(var v=e[a][d].y+3,G=e[a][d].x-3,H=e[a][d].x+3,w=0,x=0,s=0,A=0,B=0,b=Math.max(e[a][d].y-3,0);b<Math.min(v,m);b++)for(c=Math.max(G,0);c<Math.min(H,n);c++){var k=c+e[a][d].v.x,l=b+e[a][d].v.y,f=Math.floor(k),p=f+1,g=Math.floor(l),q=g+1,u=Math.floor(c),E=u+1,y=Math.floor(b),F=y+1;if(!(0>f-1||p+1>n-1||0>g-1||q+1>m-1||0>u-1||E+1>n-1||0>y-1||F+1>m-1))var C=((h[a][q][p+1]*(k-f)-h[a][q][p]*(k-f-1))*(l-g)-(h[a][g][p+1]*(k-f)-h[a][g][p]*(k-f-1))*(l-g-1)-((h[a][q][f]*(k-f)-h[a][q][f-1]*(k-f-1))*(l-g)-(h[a][g][f]*(k-f)-h[a][g][f-1]*(k-f-1))*(l-g-1)))/2,D=((h[a][q+1][p]*(l-g)-h[a][q][p]*(l-g-1))*(k-f)-(h[a][q+1][f]*(l-g)-h[a][q][f]*(l-g-1))*(k-f-1)-((h[a][g][p]*(l-g)-h[a][g-1][p]*(l-g-1))*(k-f)-(h[a][g][f]*(l-g)-h[a][g-1][f]*(l-g-1))*(k-f-1)))/2,k=(t[a][F][E]*(c-u)-t[a][F][u]*(c-u-1))*(b-y)-(t[a][y][E]*(c-u)-t[a][y][u]*(c-u-1))*(b-y-1)-((h[a][q][p]*(k-f)-h[a][q][f]*(k-f-1))*(l-g)-(h[a][g][p]*(k-f)-h[a][g][f]*(k-f-1))*(l-g-1)),w=w+C*C,x=x+D*D,s=s+C*D,A=A+k*C,B=B+k*D}w*x-s*s&&(e[a][d].v.x+=(x*A-s*B)/(w*x-s*s),e[a][d].v.y+=(w*B-s*A)/(w*x-s*s))}return e[0]};
